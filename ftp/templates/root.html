<!-- root.html -->
{% extends "base.html" %}
{% block content %}
<section class="toolbar">
   
   <!-- Create Folder -->
   <form action="{{ url_for('directories.create_directory') }}" method="POST" class="toolbar-item hover-card-container">
      <input type="hidden" name="parent_dir" value="{{ dirname if dirname != 'root' else '' }}">
      <input type="text" name="dirname" placeholder="New Folder Name" required title="Folder Name">
      <button type="submit" class="icon-btn" data-tooltip="Create Folder">
      <span class="icon folder-icon"></span>
      </button>
      <div class="hover-card">
         <h4>Create Folder</h4>
         <p>Creates a new folder in the current directory.</p>
         <p>Enter the folder name in the text box, then click this button to create it.</p>
      </div>
   </form>
   <!-- Upload File -->
   <form action="{{ url_for('directories.upload_file', dirpath=dirname if dirname != 'root' else '') }}" 
      method="POST" enctype="multipart/form-data" class="toolbar-item hover-card-container">
      <input type="file" name="file" id="upload-file" hidden onchange="this.form.submit()">
      <label for="upload-file" class="icon-btn" data-tooltip="Upload Folder">
      <span class="icon file-upload-icon"></span>
      </label>
      <button type="submit" hidden></button>
      <div class="hover-card">
         <h4>Upload File</h4>
         <p>Select a single file from your computer to upload to the current directory.</p>
         <p>The file will be uploaded immediately after selection.</p>
      </div>
   </form>
   <!-- Upload Folder -->
   <form action="{{ url_for('directories.upload_folder', dirpath=dirname if dirname != 'root' else '') }}"
      method="POST" enctype="multipart/form-data" class="toolbar-item hover-card-container">
      <input type="file" name="files" id="upload-folder" webkitdirectory multiple hidden onchange="this.form.submit()">
      <label for="upload-folder" class="icon-btn" data-tooltip="Upload Folder">
      <span class="icon folder-upload-icon"></span>
      </label>
      <button type="submit" hidden></button>
      <div class="hover-card">
         <h4>Upload Folder</h4>
         <p>Select an entire folder from your computer to upload.</p>
         <p>All files in the folder and subfolders will be uploaded automatically.</p>
         <p><strong>Note:</strong> Your browser may ask for confirmation before uploading all files.</p>
      </div>
   </form>

   <input type="file" id="drop-input" name="file" multiple hidden>
</section>
<h1>/</h1>

<!-- Folder and file list -->
<ul class="file-list">
   {% for d in directories %}
   <li class="folder" data-dirpath="{{ d if not dirpath else dirpath ~ '/' ~ d }}">
      <div class="file-item">
      <a href="{{ url_for('directories.list_directory', dirpath=d) }}">
      <span class="file-icon folder-icon"></span>
      {{ d }}
      </a>
      <div class="hover-card-container">
         <!-- Delete Folder Button -->
         <button type="button" class="icon-btn delete-btn" data-tooltip="Delete Folder"
            onclick="openDeleteModal('folder', '{{ (dirpath ~ '/' ~ d) if dirpath else d }}')">
         <span class="icon delete-folder-icon"></span>
         </button>
         <div class="hover-card delete-tooltip">
            <h4>Delete Folder ❌</h4>
            <p>Remove this folder and all of its contents permanently.</p>
         </div>
      </div>
   </li>
   {% endfor %}
   
   {% for f in files %}
   {% set ext = (f.name.rsplit('.', 1)[-1] | lower) if '.' in f.name else '' %}
   {% set icon_class = 'regular-file-icon' %}

   {# Extension-based mapping first #}
   {% if ext in ['png','jpg','jpeg','gif','webp','svg'] %}
      {% set icon_class = 'image-file-icon' %}
   {% elif ext in ['html','htm'] %}
      {% set icon_class = 'html-file-icon' %}
   {% elif ext == 'css' %}
      {% set icon_class = 'css-file-icon' %}
   {% elif ext == 'js' %}
      {% set icon_class = 'js-file-icon' %}
   {% elif ext == 'json' %}
      {% set icon_class = 'json-file-icon' %}
   {% elif ext in ['mp4','mkv','mov'] %}
      {% set icon_class = 'video-file-icon' %}
   {% elif ext in ['mp3','wav'] %}
      {% set icon_class = 'audio-file-icon' %}
   {% elif ext == 'pdf' %}
      {% set icon_class = 'pdf-file-icon' %}
   {% endif %}

   {# MIME type fallback if no extension match #}
   {% if icon_class == 'regular-file-icon' and f.mime_type is defined and f.mime_type %}
      {% if f.mime_type.startswith('image/') %}
         {% set icon_class = 'image-file-icon' %}
      {% elif f.mime_type.startswith('text/') %}
         {% set icon_class = 'text-file-icon' %}
      {% elif f.mime_type.startswith('video/') %}
         {% set icon_class = 'video-file-icon' %}
      {% elif f.mime_type.startswith('audio/') %}
         {% set icon_class = 'audio-file-icon' %}
      {% elif f.mime_type == 'application/json' %}
         {% set icon_class = 'json-file-icon' %}
      {% endif %}
   {% endif %}

   <li class="file" data-filepath="{{ (dirpath ~ '/' ~ f.name) if dirpath and dirpath != 'root' else f.name }}">
      <div class="file-item">
         <a href="{{ url_for('directories.view_file', filepath=(dirpath ~ '/' ~ f.name) if dirpath and dirpath != 'root' else f.name) }}">
            <span class="file-icon {{ icon_class }}"></span>
            {{ f.name }}
         </a>
         <div class="hover-card-container">
            <!-- Delete File Button -->
            <button type="button" class="icon-btn delete-btn" data-tooltip="Delete File"
                    onclick="openDeleteModal('file', '{{ (dirpath ~ '/' ~ f.name) if dirpath else f.name }}')">
               <span class="icon delete-file-icon"></span>
            </button>
            <div class="hover-card delete-tooltip">
               <h4>Delete File ❌</h4>
               <p>Delete this file permanently. This action cannot be undone.</p>
            </div>
         </div>
      </div>
   </li>
   {% endfor %}
</ul>
<!-- Delete Confirmation Box -->
<div id="deleteModal" class="modal" style="display:none;">
   <div class="modal-content">
      <p id="deleteMessage">Are you sure you want to delete this item?</p>
      <form id="deleteForm" method="POST">
         <input type="hidden" name="dirpath" id="modalDirpath">
         <input type="hidden" name="filepath" id="modalFilepath">
         <div class="modal-buttons">
            <button type="submit" class="btn btn-danger">Yes, Delete</button>
            <button type="button" class="btn btn-cancel" onclick="closeDeleteModal()">Cancel</button>
         </div>
      </form>
   </div>
</div>
<!-- Context Menu -->
<ul id="contextMenu" class="context-menu" style="display:none; position:absolute;">
   <!-- Open Options -->
   <li class="context-item" data-action="open">Open</li>
   <li class="context-item" data-action="open-new-tab">Open in New Tab</li>
   <li class="context-item" data-action="open-new-window">Open in New Window</li>
   <li class="separator"></li>

   <!-- Preview -->
   <li class="context-item" data-action="preview">Preview (Unsupported)</li>
   <li class="separator"></li>

   <!-- Basic Actions -->
   <li class="context-item" data-action="download">Download</li>
   <li class="context-item" data-action="delete">Delete</li>
   <li class="separator"></li>

   <!-- Clipboard Actions -->
   <li class="context-item" data-action="copy">Copy</li>
   <li class="context-item" data-action="paste">Paste</li>
   <li class="context-item" data-action="cut">Cut</li>
   <li class="context-item" data-action="duplicate">Duplicate</li>
   <li class="separator"></li>

   <!-- Sharing -->
   <li class="context-item" data-action="share">Share (Unsupported)</li>
   <li class="context-item" data-action="get-link">Get Link (Supported)</li>
   <li class="separator"></li>

   <!-- Metadata & Compression -->
   <li class="context-item" data-action="view-metadata">View Metadata (Unsupported)</li>
   <li class="context-item" data-action="compress">Compress (Unsupported)</li>
   <li class="context-item" data-action="extract">Extract (Unsupported)</li>
</ul>
<script>
   function openDeleteModal(type, path) {
       const modal = document.getElementById('deleteModal');
       const message = document.getElementById('deleteMessage');
       const dirInput = document.getElementById('modalDirpath');
       const fileInput = document.getElementById('modalFilepath');
   
       if (type === 'folder') {
           message.textContent = `Are you sure you want to delete folder "${path}" and all its contents?`;
           dirInput.value = path;
           fileInput.value = '';
           document.getElementById('deleteForm').action = "{{ url_for('directories.delete_directory') }}";
       } else if (type === 'file') {
           message.textContent = `Are you sure you want to delete file "${path}"?`;
           fileInput.value = path;
           dirInput.value = '';
           document.getElementById('deleteForm').action = "{{ url_for('directories.delete_file') }}";
       }
   
       modal.style.display = 'flex';
   }
   
   function closeDeleteModal() {
       document.getElementById('deleteModal').style.display = 'none';
   }
   
   document.querySelectorAll('.hover-card-container').forEach(container => {
     const card = container.querySelector('.hover-card');
     let timeout;
   
     container.addEventListener('mouseenter', () => {
       timeout = setTimeout(() => {
         card.style.opacity = '1';
         card.style.visibility = 'visible';
       }, 1000); 
     });
   
     container.addEventListener('mouseleave', () => {
       clearTimeout(timeout);
       card.style.opacity = '0';
       card.style.visibility = 'hidden';
     });
   });

const dropInput = document.getElementById("drop-input");

document.body.addEventListener("dragover", (e) => {
  e.preventDefault();
  document.body.classList.add("drag-over");
});

document.body.addEventListener("dragleave", (e) => {
  e.preventDefault();
  document.body.classList.remove("drag-over");
});

document.body.addEventListener("drop", (e) => {
  e.preventDefault();
  document.body.classList.remove("drag-over");
  handleFiles(e.dataTransfer.files);
});

dropInput.addEventListener("change", () => {
  handleFiles(dropInput.files);
});

function handleFiles(files) {
  if (!files.length) return;

  const formData = new FormData();
  for (const file of files) {
    formData.append("file", file);
  }

  const uploadUrl = "{{ url_for('directories.upload_file', dirpath='') }}";

  fetch(uploadUrl, {
    method: "POST",
    body: formData,
  })
  .then(res => {
    if (res.ok) location.reload();
    else alert("Upload failed");
  })
  .catch(err => {
    console.error(err);
    alert("Error uploading file");
  });
}

const contextMenu = document.getElementById('contextMenu');
let contextTarget = null;
let targetPath = '';
let targetType = ''; 

function resolveFolderUrl(path) {
   if (!path || path === 'root') return '/';
   if (path.startsWith('root/')) path = path.slice(5);
   return `/${encodeURIComponent(path)}/`;
}

document.querySelectorAll('.file-list li').forEach(item => {
    item.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        contextTarget = this;
        targetPath = this.dataset.filepath || this.dataset.dirpath || '';
        targetType = this.dataset.filepath ? 'file' : 'folder';

   contextMenu.style.visibility = 'hidden';
   contextMenu.style.display = 'block';
    
   let menuWidth = contextMenu.offsetWidth;
   let menuHeight = contextMenu.offsetHeight;
   let posX = e.clientX + window.scrollX;
   let posY = e.clientY + window.scrollY;

   if (posX + menuWidth > window.scrollX + window.innerWidth) {
        posX = window.scrollX + window.innerWidth - menuWidth - 5;
   }
   if (posY + menuHeight > window.scrollY + window.innerHeight) {
        posY = window.scrollY + window.innerHeight - menuHeight - 5;
   }

   contextMenu.style.top = `${posY}px`;
   contextMenu.style.left = `${posX}px`;
   contextMenu.style.display = 'block';
   contextMenu.style.visibility = 'visible';
   });
});

document.addEventListener('click', () => {
    contextMenu.style.display = 'none';
});

document.querySelectorAll('#contextMenu .context-item').forEach(item => {
    item.addEventListener('click', () => {
        const action = item.dataset.action;
        console.log(`Action "${action}" on:`, targetPath);
        contextMenu.style.display = 'none';

        if(targetType === 'file') {
            const fileUrl = `/file/${encodeURIComponent(targetPath)}`;
            if(action === 'open') window.location.href = fileUrl;
            if(action === 'open-new-tab') window.open(fileUrl, '_blank');
            if(action === 'open-new-window') window.open(fileUrl, '_blank', 'width=900,height=600,resizable=yes');
            else if (action === 'download') {
               console.log("Download", targetPath);
               window.open(`/download?path=${encodeURIComponent(targetPath)}`, '_self');
}
        } 
        
         else if(targetType === 'folder') {
         const folderUrl = resolveFolderUrl(targetPath);
            if(action === 'open') window.location.href = folderUrl;
            if(action === 'open-new-tab') window.open(folderUrl, '_blank');
            if(action === 'open-new-window') window.open(folderUrl, '_blank', 'width=900,height=600,resizable=yes');
        }

        console.log(`Action "${action}" on ${targetType}:`, targetPath);
        contextMenu.style.display = 'none';
    });
});

document.addEventListener('keydown', e => {
    if(e.key === 'Escape') contextMenu.style.display = 'none';
});

window.addEventListener('beforeunload', () => {
    const folderPath = window.location.pathname;
    sessionStorage.setItem('scroll_' + folderPath, window.scrollY);
});

window.addEventListener('load', () => {
    const folderPath = window.location.pathname;
    const scrollPos = sessionStorage.getItem('scroll_' + folderPath);
    if (scrollPos) {
        window.scrollTo(0, parseInt(scrollPos));
        sessionStorage.removeItem('scroll_' + folderPath);
    }
});
</script>
{% endblock %}
{#
- Some file objects may not have a 'mime_type' attribute (e.g., dummy files or root files).
- Always check:
{% if f.mime_type is defined and f.mime_type and f.mime_type.startswith('image/') %}
This prevents Jinja `UndefinedError`.
#}
